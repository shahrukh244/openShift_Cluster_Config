---
- name: Disable Swap for OpenShift (RHEL 10.1)
  hosts: localhost
  become: true
  gather_facts: false

  tasks:

    - name: Disable swap immediately
      ansible.builtin.shell: |
        if swapon --show | grep -q "^/"; then
          swapoff -a
        else
          exit 100
        fi
      register: swapoff_result
      changed_when: "swapoff_result.rc == 0"
      failed_when: "swapoff_result.rc != 0 and swapoff_result.rc != 100"

    - name: Comment out swap entries in /etc/fstab
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^([^#\s]+\s+([^#\s]+\s+)?swap\s+.*)$'
        replace: '# \1'
      register: fstab_result

    - name: Debug swap status
      ansible.builtin.debug:
        msg: "Swap has been permanently disabled in fstab."
      when: fstab_result.changed

    - name: Verify swap is disabled
      ansible.builtin.command: swapon --show
      register: swapon_check
      changed_when: false

    - name: Report Current Swap
      ansible.builtin.debug:
        msg: "{{ 'Swap is still active!' if swapon_check.stdout != '' else 'Confirmed: Swap is inactive.' }}"
